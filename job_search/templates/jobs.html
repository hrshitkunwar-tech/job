{% extends "base.html" %}
{% block title %}Jobs - Job Search{% endblock %}
{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center mb-2">
        <h1 class="text-2xl font-bold text-gray-900">Job Listings</h1>
        <div class="flex items-center gap-2">
            <div class="inline-flex rounded-lg border border-gray-300 overflow-hidden">
                <button id="view-grid-btn" type="button"
                    class="view-toggle-btn px-3 py-2 text-xs font-semibold text-gray-700 bg-white hover:bg-gray-50">
                    Grid
                </button>
                <button id="view-kanban-btn" type="button"
                    class="view-toggle-btn px-3 py-2 text-xs font-semibold text-gray-700 bg-white hover:bg-gray-50 border-l border-gray-300">
                    Kanban
                </button>
            </div>
            <a href="/search"
                class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700">New
                Search</a>
        </div>
    </div>
    {% if search_id %}
    <div
        class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg flex justify-between items-center text-sm">
        <span class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Filtered to Search Session #{{ search_id }}
        </span>
        <a href="/jobs?show_all=true" class="underline font-medium hover:text-blue-900">View All Saved Jobs</a>
    </div>
    {% endif %}
</div>

<!-- Filters & History -->
<div class="bg-white rounded-lg shadow p-4 mb-6 grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
    <div class="md:col-span-1">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Search History</label>
        <select id="search-history-select"
            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50">
            <option value="">-- All Runs --</option>
            {% for run in search_runs %}
            <option value="{{ run.id }}" {{ 'selected' if search_id==run.id else '' }}>
                {{ run.name }} ({{ run.created_at.strftime('%m/%d') }})
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="md:col-span-1">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Keyword</label>
        <input type="text" id="filter-search" placeholder="Filter current results..."
            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
    </div>
    <div class="md:col-span-1">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Work Type</label>
        <select id="filter-work-type" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">All Types</option>
            <option value="remote" {{ work_type == 'remote' and 'selected' or '' }}>Remote</option>
            <option value="hybrid" {{ work_type == 'hybrid' and 'selected' or '' }}>Hybrid</option>
            <option value="onsite" {{ work_type == 'onsite' and 'selected' or '' }}>On-site</option>
        </select>
    </div>
    <div class="md:col-span-1">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Search Time</label>
        <select id="filter-search-time" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50">
            <option value="" {{ '' == search_time and 'selected' or '' }}>All Time</option>
            <option value="today" {{ search_time == 'today' and 'selected' or '' }}>Today</option>
            <option value="yesterday" {{ search_time == 'yesterday' and 'selected' or '' }}>Yesterday</option>
            <option value="last_week" {{ search_time == 'last_week' and 'selected' or '' }}>Last Week</option>
        </select>
    </div>
    <div class="md:col-span-1">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Application Status</label>
        <select id="filter-app-status" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50">
            <option value="" {{ '' == app_status and 'selected' or '' }}>All</option>
            <option value="unapplied" {{ app_status == 'unapplied' and 'selected' or '' }}>Unapplied ({{ app_status_counts.unapplied }})</option>
            <option value="queued" {{ app_status == 'queued' and 'selected' or '' }}>Queued ({{ app_status_counts.queued }})</option>
            <option value="in_progress" {{ app_status == 'in_progress' and 'selected' or '' }}>In Progress ({{ app_status_counts.in_progress }})</option>
            <option value="submitted" {{ app_status == 'submitted' and 'selected' or '' }}>Submitted ({{ app_status_counts.submitted }})</option>
            <option value="reviewed" {{ app_status == 'reviewed' and 'selected' or '' }}>Reviewed ({{ app_status_counts.reviewed }})</option>
            <option value="failed" {{ app_status == 'failed' and 'selected' or '' }}>Failed ({{ app_status_counts.failed }})</option>
            <option value="active_pipeline" {{ app_status == 'active_pipeline' and 'selected' or '' }}>Queued + In Progress</option>
        </select>
    </div>
    <div class="md:col-span-1">
        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Min Match Score</label>
        <div
            class="flex items-center gap-2 text-sm text-gray-600 px-3 py-1 bg-gray-50 rounded-md border border-gray-200">
            <input type="range" id="filter-min-score" min="0" max="100" value="0" class="flex-grow">
            <span id="score-display" class="font-bold text-indigo-600">0</span>%
        </div>
    </div>
</div>

<!-- Batch Auto-Apply Controls -->
<div class="bg-white rounded-lg shadow p-4 mb-6 border border-indigo-100">
    <div class="flex flex-col md:flex-row md:items-end gap-4">
        <div class="flex items-center gap-2">
            <input type="checkbox" id="select-visible" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <label for="select-visible" class="text-sm font-medium text-gray-700">Select all visible jobs</label>
        </div>
        <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Min Score</label>
            <input id="batch-min-score" type="number" min="0" max="100" value="{{ auto_apply_min_score|int }}"
                class="w-28 px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>
        <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Resume</label>
            <select id="batch-resume-id" class="w-60 px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50">
                <option value="">Primary Resume</option>
                {% for resume in resumes %}
                <option value="{{ resume.id }}">{{ resume.name }}{% if resume.is_primary %} (Primary){% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex items-center gap-2">
            <input type="checkbox" id="batch-safe-mode" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <label for="batch-safe-mode" class="text-sm text-gray-700">Safe mode</label>
        </div>
        <div class="flex items-center gap-2">
            <input type="checkbox" id="batch-auto-automate" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <label for="batch-auto-automate" class="text-sm text-gray-700">Auto start automation</label>
        </div>
        <button id="batch-apply-btn"
            class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
            Apply Selected
        </button>
        <button id="autonomous-run-btn"
            class="px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed">
            Run Autonomous Workflow
        </button>
        <button id="autonomous-stop-btn"
            class="px-4 py-2 bg-rose-600 text-white text-sm font-medium rounded-lg hover:bg-rose-700 disabled:opacity-50 disabled:cursor-not-allowed">
            Stop Running Automation
        </button>
        <button id="batch-delete-btn"
            class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
            Delete Selected
        </button>
    </div>
    <p id="batch-status" class="mt-2 text-sm text-gray-600"></p>
    <p id="autonomous-status" class="mt-1 text-sm text-emerald-700"></p>
</div>

<!-- Status Summary -->
<div class="bg-white rounded-lg shadow p-4 mb-6 border border-gray-100">
    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Current Job Status</div>
    <div class="flex flex-wrap gap-2 text-xs">
        <span class="px-2 py-1 rounded bg-gray-100 text-gray-700">Unapplied: {{ app_status_counts.unapplied }}</span>
        <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-800">Queued: {{ app_status_counts.queued }}</span>
        <span class="px-2 py-1 rounded bg-blue-100 text-blue-800">In Progress: {{ app_status_counts.in_progress }}</span>
        <span class="px-2 py-1 rounded bg-green-100 text-green-800">Submitted: {{ app_status_counts.submitted }}</span>
        <span class="px-2 py-1 rounded bg-gray-100 text-gray-700">Reviewed: {{ app_status_counts.reviewed }}</span>
        <span class="px-2 py-1 rounded bg-red-100 text-red-700">Failed: {{ app_status_counts.failed }}</span>
    </div>
</div>

<!-- Job Grid -->
{% set has_jobs = jobs|length > 0 %}
{% if has_jobs %}
<div id="jobs-view-container" class="jobs-view-grid">
{% for group in grouped_jobs %}
{% if group.count > 0 %}
<div class="mb-6 job-group" data-group-status="{{ group.status }}">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-800">{{ group.label }}</h2>
        <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-700" data-group-count>{{ group.count }}</span>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 job-group-cards" id="jobs-grid-{{ group.status }}">
        {% for job in group.jobs %}
        {% set app = application_by_job.get(job.id) %}
        {% set app_status_value = app.status.value if app else 'unapplied' %}
        <div class="job-card relative" data-job-id="{{ job.id }}" data-title="{{ job.title|lower }}" data-company="{{ job.company|lower }}"
            data-work-type="{{ job.work_type or '' }}" data-score="{{ job.match_score or 0 }}" data-app-status="{{ app_status_value }}">
            <div class="absolute top-2 left-2 z-10 bg-white/90 rounded p-1 shadow-sm"
                onclick="event.stopPropagation()">
                <input type="checkbox" class="job-select-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded"
                    data-job-id="{{ job.id }}" data-app-status="{{ app_status_value }}">
            </div>
            <div class="absolute top-2 right-2 z-10">
                {% if app %}
                    {% if app_status_value == 'submitted' %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">submitted</span>
                    {% elif app_status_value == 'queued' %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">queued</span>
                    {% elif app_status_value == 'in_progress' %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">in progress</span>
                    {% elif app_status_value == 'reviewed' %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">reviewed</span>
                    {% elif app_status_value == 'failed' %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">failed</span>
                    {% else %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">{{ app_status_value }}</span>
                    {% endif %}
                {% else %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800">unapplied</span>
                {% endif %}
            </div>
            {% include "partials/job_card.html" %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endfor %}
</div>
{% else %}
<div class="col-span-full bg-white rounded-lg shadow p-8 text-center text-gray-500">
    <p class="text-lg">No jobs found yet</p>
    <p class="mt-2">Go to <a href="/search" class="text-indigo-600 hover:underline">Search</a> to find jobs on
        LinkedIn.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const viewGridBtn = document.getElementById('view-grid-btn');
    const viewKanbanBtn = document.getElementById('view-kanban-btn');
    const jobsViewContainer = document.getElementById('jobs-view-container');
    const searchInput = document.getElementById('filter-search');
    const workTypeSelect = document.getElementById('filter-work-type');
    const searchTimeSelect = document.getElementById('filter-search-time');
    const appStatusSelect = document.getElementById('filter-app-status');
    const searchHistorySelect = document.getElementById('search-history-select');
    const scoreSlider = document.getElementById('filter-min-score');
    const scoreDisplay = document.getElementById('score-display');
    const selectVisible = document.getElementById('select-visible');
    const batchApplyBtn = document.getElementById('batch-apply-btn');
    const batchStatus = document.getElementById('batch-status');
    const batchMinScoreInput = document.getElementById('batch-min-score');
    const batchResumeSelect = document.getElementById('batch-resume-id');
    const batchSafeMode = document.getElementById('batch-safe-mode');
    const batchAutoAutomate = document.getElementById('batch-auto-automate');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    const autonomousRunBtn = document.getElementById('autonomous-run-btn');
    const autonomousStopBtn = document.getElementById('autonomous-stop-btn');
    const autonomousStatus = document.getElementById('autonomous-status');
    let autonomousRunId = null;
    let autonomousRunState = 'idle';
    let autonomousPollTimer = null;

    function isActionableStatus(status) {
        return !status || ['unapplied', 'reviewed', 'failed'].includes(status);
    }

    function applyServerFilters() {
        const params = new URLSearchParams();
        const sid = searchHistorySelect?.value || '';
        const qVal = (searchInput?.value || '').trim();
        const wtVal = (workTypeSelect?.value || '').trim();
        const appVal = (appStatusSelect?.value || '').trim();
        const timeVal = (searchTimeSelect?.value || '').trim();

        if (sid) {
            params.set('search_id', sid);
        } else {
            params.set('show_all', 'true');
        }
        if (qVal) params.set('q', qVal);
        if (wtVal) params.set('work_type', wtVal);
        if (appVal) params.set('app_status', appVal);
        if (timeVal) params.set('search_time', timeVal);

        window.location.href = `/jobs?${params.toString()}`;
    }

    function filterJobs() {
        const search = searchInput.value.toLowerCase();
        const workType = workTypeSelect.value;
        const appStatus = appStatusSelect?.value || '';
        const minScore = parseInt(scoreSlider.value);
        scoreDisplay.textContent = minScore;

        document.querySelectorAll('.job-card').forEach(card => {
            const title = card.dataset.title;
            const company = card.dataset.company;
            const cardWorkType = card.dataset.workType;
            const cardAppStatus = card.dataset.appStatus || 'unapplied';
            const score = parseFloat(card.dataset.score);

            const matchesSearch = !search || title.includes(search) || company.includes(search);
            const matchesType = !workType || cardWorkType === workType;
            const matchesScore = score >= minScore;
            const matchesAppStatus = !appStatus ||
                (appStatus === 'active_pipeline'
                    ? ['queued', 'in_progress'].includes(cardAppStatus)
                    : cardAppStatus === appStatus);

            card.style.display = matchesSearch && matchesType && matchesScore && matchesAppStatus ? '' : 'none';
        });
        syncSelectVisibleState();
    }

    function visibleJobCards() {
        return Array.from(document.querySelectorAll('.job-card')).filter(card => card.style.display !== 'none');
    }

    function selectedJobIds() {
        return Array.from(document.querySelectorAll('.job-select-checkbox:checked'))
            .filter(cb => isActionableStatus(cb.dataset.appStatus))
            .map(cb => parseInt(cb.dataset.jobId))
            .filter(Boolean);
    }

    function selectedJobIdsForDelete() {
        return Array.from(document.querySelectorAll('.job-select-checkbox:checked'))
            .map(cb => parseInt(cb.dataset.jobId))
            .filter(Boolean);
    }

    function setJobsView(mode) {
        if (!jobsViewContainer) return;
        const isKanban = mode === 'kanban';
        jobsViewContainer.classList.toggle('jobs-view-kanban', isKanban);
        jobsViewContainer.classList.toggle('jobs-view-grid', !isKanban);
        viewGridBtn?.classList.toggle('active', !isKanban);
        viewKanbanBtn?.classList.toggle('active', isKanban);
        localStorage.setItem('jobsViewMode', isKanban ? 'kanban' : 'grid');
    }

    function syncSelectVisibleState() {
        const visible = visibleJobCards();
        if (visible.length === 0) {
            selectVisible.checked = false;
            selectVisible.indeterminate = false;
            return;
        }
        const selectedCount = visible.filter(card => card.querySelector('.job-select-checkbox')?.checked).length;
        selectVisible.checked = selectedCount > 0 && selectedCount === visible.length;
        selectVisible.indeterminate = selectedCount > 0 && selectedCount < visible.length;
    }

    function updateBatchButtonState() {
        const selected = selectedJobIds().length;
        const selectedAny = selectedJobIdsForDelete().length;
        const nonActionableSelected = Array.from(document.querySelectorAll('.job-select-checkbox:checked'))
            .filter(cb => !isActionableStatus(cb.dataset.appStatus))
            .length;
        batchApplyBtn.disabled = selected === 0;
        autonomousRunBtn.disabled = selected === 0;
        if (autonomousRunState === 'running' || autonomousRunState === 'queued') {
            autonomousRunBtn.disabled = true;
        }
        batchDeleteBtn.disabled = selectedAny === 0;
        batchApplyBtn.textContent = selected > 0 ? `Apply Selected (${selected})` : 'Apply Selected';
        autonomousRunBtn.textContent = selected > 0 ? `Run Autonomous (${selected})` : 'Run Autonomous Workflow';
        batchDeleteBtn.textContent = selectedAny > 0 ? `Delete Selected (${selectedAny})` : 'Delete Selected';
        if (autonomousStopBtn) {
            const hasActiveRun = !!autonomousRunId && ['queued', 'running'].includes((autonomousRunState || '').toLowerCase());
            autonomousStopBtn.disabled = !hasActiveRun;
        }
        if (nonActionableSelected > 0) {
            batchStatus.textContent = `Ignored ${nonActionableSelected} selected job(s) already queued/in_progress/submitted.`;
        }
        syncSelectVisibleState();
    }

    function pollAutonomousRun(runId) {
        if (autonomousPollTimer) clearInterval(autonomousPollTimer);
        autonomousPollTimer = setInterval(async () => {
            try {
                const res = await fetch(`/api/autonomous/runs/${runId}`);
                if (!res.ok) return;
                const data = await res.json();
                autonomousRunState = data.status || 'idle';
                autonomousStatus.textContent =
                    `Run #${data.run_id}: ${data.status} | processed ${data.processed_jobs}/${data.total_jobs} | submitted ${data.submitted_jobs} | failed ${data.failed_jobs} | skipped ${data.skipped_jobs}`;
                if (["completed", "failed", "stopped"].includes(data.status)) {
                    clearInterval(autonomousPollTimer);
                    autonomousPollTimer = null;
                    try {
                        const logsRes = await fetch(`/api/autonomous/runs/${runId}/logs`);
                        if (logsRes.ok) {
                            const logs = await logsRes.json();
                            const firstImportant = logs.find(l => l.status === 'failed' || l.status === 'skipped');
                            if (firstImportant && firstImportant.message) {
                                autonomousStatus.textContent += ` | reason: ${firstImportant.message}`;
                            }
                        }
                    } catch (e) {
                        // keep summary without extra reason
                    }
                    autonomousRunId = null;
                }
                updateBatchButtonState();
            } catch (e) {
                // keep polling
            }
        }, 2000);
    }

    async function restoreActiveRun() {
        try {
            const res = await fetch('/api/autonomous/active-run');
            if (!res.ok) return;
            const data = await res.json();
            if (!data || !data.run_id) {
                updateBatchButtonState();
                return;
            }
            autonomousRunId = data.run_id;
            autonomousRunState = data.status || 'running';
            autonomousStatus.textContent =
                `Run #${data.run_id}: ${data.status} | processed ${data.processed_jobs}/${data.total_jobs} | submitted ${data.submitted_jobs} | failed ${data.failed_jobs} | skipped ${data.skipped_jobs}`;
            pollAutonomousRun(autonomousRunId);
            updateBatchButtonState();
        } catch (e) {
            // no-op
        }
    }

    let keywordApplyTimer = null;
    searchInput?.addEventListener('input', () => {
        filterJobs();
        if (keywordApplyTimer) clearTimeout(keywordApplyTimer);
        keywordApplyTimer = setTimeout(() => applyServerFilters(), 450);
    });
    searchInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyServerFilters();
        }
    });
    workTypeSelect?.addEventListener('change', applyServerFilters);
    appStatusSelect?.addEventListener('change', applyServerFilters);
    searchTimeSelect?.addEventListener('change', applyServerFilters);
    scoreSlider?.addEventListener('input', filterJobs);
    searchHistorySelect?.addEventListener('change', applyServerFilters);
    document.querySelectorAll('.job-select-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBatchButtonState);
    });

    selectVisible?.addEventListener('change', () => {
        const checked = selectVisible.checked;
        visibleJobCards().forEach(card => {
            const cb = card.querySelector('.job-select-checkbox');
            if (!cb) return;
            cb.checked = checked;
        });
        updateBatchButtonState();
    });

    batchApplyBtn?.addEventListener('click', async () => {
        const jobIds = selectedJobIds();
        if (jobIds.length === 0) {
            batchStatus.textContent = 'Select at least one job.';
            return;
        }

        const payload = {
            job_ids: jobIds,
            min_score: parseFloat(batchMinScoreInput.value || '0'),
            auto_automate: batchAutoAutomate.checked,
            resume_id: batchResumeSelect.value ? parseInt(batchResumeSelect.value) : null,
            safe_mode: batchSafeMode.checked,
            require_confirmation: batchSafeMode.checked,
        };

        batchApplyBtn.disabled = true;
        batchStatus.textContent = 'Submitting selected jobs...';

        try {
            const res = await fetch('/api/applications/batch-apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.detail || 'Batch apply failed');
            }
            batchStatus.textContent =
                `Created ${data.created} application(s), skipped ${data.skipped} below threshold/duplicates.`;
            document.querySelectorAll('.job-select-checkbox:checked').forEach(cb => { cb.checked = false; });
            updateBatchButtonState();
        } catch (err) {
            batchStatus.textContent = `Error: ${err.message}`;
        } finally {
            updateBatchButtonState();
        }
    });

    autonomousRunBtn?.addEventListener('click', async () => {
        const jobIds = selectedJobIds();
        if (jobIds.length === 0) {
            autonomousStatus.textContent = 'Select at least one job.';
            return;
        }

        const payload = {
            job_ids: jobIds,
            resume_id: batchResumeSelect.value ? parseInt(batchResumeSelect.value) : null,
            min_score: parseFloat(batchMinScoreInput.value || '0'),
            safe_mode: false,
            require_confirmation: false,
            max_retries: 2,
        };

        autonomousRunBtn.disabled = true;
        autonomousStatus.textContent = 'Starting autonomous workflow...';
        try {
            const res = await fetch('/api/autonomous/runs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Failed to start autonomous workflow');
            autonomousRunId = data.run_id;
            autonomousRunState = data.status || 'running';
            autonomousStatus.textContent = `Autonomous run #${autonomousRunId} started.`;
            pollAutonomousRun(autonomousRunId);
        } catch (err) {
            autonomousStatus.textContent = `Error: ${err.message}`;
            autonomousRunState = 'idle';
        } finally {
            updateBatchButtonState();
        }
    });

    autonomousStopBtn?.addEventListener('click', async () => {
        autonomousStopBtn.disabled = true;
        autonomousStatus.textContent = 'Stopping active automation...';
        try {
            if (autonomousRunId) {
                await fetch(`/api/autonomous/runs/${autonomousRunId}/stop`, { method: 'POST' });
            }
            await fetch('/api/applications/stop-active', { method: 'POST' });
            autonomousRunState = 'stopped';
            autonomousStatus.textContent = autonomousRunId
                ? `Stop requested for run #${autonomousRunId}.`
                : 'Stop requested for running applications.';
        } catch (err) {
            autonomousStatus.textContent = `Stop request failed: ${err.message}`;
        } finally {
            updateBatchButtonState();
        }
    });

    batchDeleteBtn?.addEventListener('click', async () => {
        const jobIds = selectedJobIdsForDelete();
        if (jobIds.length === 0) {
            batchStatus.textContent = 'Select at least one job to delete.';
            return;
        }
        const confirmed = window.confirm(`Delete ${jobIds.length} selected job listing(s)? This also removes linked applications/logs.`);
        if (!confirmed) return;

        batchDeleteBtn.disabled = true;
        batchStatus.textContent = 'Deleting selected jobs...';

        try {
            const res = await fetch('/api/jobs/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ job_ids: jobIds }),
            });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.detail || 'Delete failed');
            }

            batchStatus.textContent = `Deleted ${data.deleted} job listing(s).`;
            setTimeout(() => window.location.reload(), 350);
        } catch (err) {
            batchStatus.textContent = `Error: ${err.message}`;
            updateBatchButtonState();
        }
    });

    viewGridBtn?.addEventListener('click', () => setJobsView('grid'));
    viewKanbanBtn?.addEventListener('click', () => setJobsView('kanban'));

    // Initialize filters from URL
    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    if (q && searchInput) searchInput.value = q;
    const savedView = localStorage.getItem('jobsViewMode') || 'kanban';
    setJobsView(savedView === 'kanban' ? 'kanban' : 'grid');
    filterJobs();
    restoreActiveRun();
    updateBatchButtonState();
</script>
<style>
    .view-toggle-btn.active {
        background-color: #4f46e5;
        color: #fff;
    }
    #jobs-view-container.jobs-view-kanban {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }
    #jobs-view-container.jobs-view-kanban .job-group {
        margin-bottom: 0;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 0.75rem;
    }
    #jobs-view-container.jobs-view-kanban .job-group-cards {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    #jobs-view-container.jobs-view-kanban .job-card {
        margin: 0;
    }
</style>
{% endblock %}
